{# Página: Distribución de Clientes por Rango de Facturación #}
{% include 'reports/components/header.html' %}

<div class="section">
    <h2 class="section-title">Distribución de Clientes por Rango</h2>
    
    <p class="mb-20 text-muted">
        Segmentación de la cartera de clientes según su nivel de facturación,
        permitiendo identificar oportunidades de crecimiento y estrategias diferenciadas.
    </p>

    {# Resumen de cartera #}
    <div class="row mb-30">
        <div class="col-4">
            <div class="metric-box">
                <div class="label">Total Clientes Activos</div>
                <div class="value" style="color: var(--primary);">
                    {% if top_clientes %}
                        {{ top_clientes | length }}
                    {% else %}
                        0
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-4">
            <div class="metric-box">
                <div class="label">Facturación Promedio</div>
                <div class="value" style="color: var(--success);">
                    {% if top_clientes and top_clientes|length > 0 %}
                        {{ (top_clientes | sum(attribute='facturacion') / top_clientes|length) | format_currency }}
                    {% else %}
                        $0
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-4">
            <div class="metric-box">
                <div class="label">Clientes Top 20%</div>
                <div class="value" style="color: var(--secondary);">
                    {% if top_clientes %}
                        {{ ((top_clientes | length * 0.2) | round(0, 'ceil')) | int }}
                    {% else %}
                        0
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {# Tabla de distribución por rangos #}
    <h3 class="section-subtitle">Clientes por Rango de Facturación</h3>
    
    {% if top_clientes %}
    {% set total_facturacion = top_clientes | sum(attribute='facturacion') %}
    {% set clientes_por_rango = {
        'Alto (>$100k)': {'cantidad': 0, 'facturacion': 0},
        'Medio-Alto ($50k-$100k)': {'cantidad': 0, 'facturacion': 0},
        'Medio ($20k-$50k)': {'cantidad': 0, 'facturacion': 0},
        'Pequeño (<$20k)': {'cantidad': 0, 'facturacion': 0}
    } %}
    
    {% for cliente in top_clientes %}
        {% set fact = cliente.get('facturacion', 0) %}
        {% if fact >= 100000 %}
            {% set _ = clientes_por_rango['Alto (>$100k)'].update({'cantidad': clientes_por_rango['Alto (>$100k)']['cantidad'] + 1, 'facturacion': clientes_por_rango['Alto (>$100k)']['facturacion'] + fact}) %}
        {% elif fact >= 50000 %}
            {% set _ = clientes_por_rango['Medio-Alto ($50k-$100k)'].update({'cantidad': clientes_por_rango['Medio-Alto ($50k-$100k)']['cantidad'] + 1, 'facturacion': clientes_por_rango['Medio-Alto ($50k-$100k)']['facturacion'] + fact}) %}
        {% elif fact >= 20000 %}
            {% set _ = clientes_por_rango['Medio ($20k-$50k)'].update({'cantidad': clientes_por_rango['Medio ($20k-$50k)']['cantidad'] + 1, 'facturacion': clientes_por_rango['Medio ($20k-$50k)']['facturacion'] + fact}) %}
        {% else %}
            {% set _ = clientes_por_rango['Pequeño (<$20k)'].update({'cantidad': clientes_por_rango['Pequeño (<$20k)']['cantidad'] + 1, 'facturacion': clientes_por_rango['Pequeño (<$20k)']['facturacion'] + fact}) %}
        {% endif %}
    {% endfor %}
    
    <table>
        <thead>
            <tr>
                <th>Rango de Facturación</th>
                <th class="text-right">Cantidad Clientes</th>
                <th class="text-right">Facturación Total</th>
                <th class="text-right">% del Total</th>
                <th class="text-right">Promedio/Cliente</th>
            </tr>
        </thead>
        <tbody>
            {% for rango, data in clientes_por_rango.items() %}
            <tr>
                <td class="font-semibold">{{ rango }}</td>
                <td class="text-right">{{ data.cantidad }}</td>
                <td class="text-right">{{ data.facturacion | format_currency }}</td>
                <td class="text-right">
                    {{ ((data.facturacion / total_facturacion * 100) if total_facturacion > 0 else 0) | format_percentage }}
                </td>
                <td class="text-right">
                    {{ ((data.facturacion / data.cantidad) if data.cantidad > 0 else 0) | format_currency }}
                </td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot>
            <tr style="background: var(--gray-100); font-weight: bold;">
                <td>TOTAL</td>
                <td class="text-right">{{ top_clientes | length }}</td>
                <td class="text-right">{{ total_facturacion | format_currency }}</td>
                <td class="text-right">100.00%</td>
                <td class="text-right">
                    {{ ((total_facturacion / top_clientes|length) if top_clientes|length > 0 else 0) | format_currency }}
                </td>
            </tr>
        </tfoot>
    </table>
    {% else %}
    <div class="card text-center" style="padding: 40px;">
        <p class="text-muted">No hay datos de clientes disponibles para análisis de rangos.</p>
    </div>
    {% endif %}

    {# Análisis estratégico #}
    <div class="card mt-30" style="background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%); border-left: 4px solid #F59E0B;">
        <h3 class="section-subtitle">Análisis Estratégico de Cartera</h3>
        <div class="row" style="margin-top: 15px;">
            <div class="col-6">
                <h4 style="color: var(--primary); font-size: 11pt; margin-bottom: 10px;">Segmentos Identificados:</h4>
                <ul style="margin-left: 20px; line-height: 2;">
                    <li><strong>Alto Valor:</strong> Clientes estratégicos - Requieren atención personalizada</li>
                    <li><strong>Medio-Alto:</strong> Potencial de crecimiento - Oportunidades de upselling</li>
                    <li><strong>Medio:</strong> Base sólida - Estrategias de retención</li>
                    <li><strong>Pequeño:</strong> Volumen - Eficiencia operativa</li>
                </ul>
            </div>
            <div class="col-6">
                <h4 style="color: var(--primary); font-size: 11pt; margin-bottom: 10px;">Recomendaciones:</h4>
                <ul style="margin-left: 20px; line-height: 2;">
                    <li>Desarrollar planes de cuenta para clientes de alto valor</li>
                    <li>Identificar clientes con potencial de migración ascendente</li>
                    <li>Optimizar costos de servicio en segmento pequeño</li>
                    <li>Implementar programas de fidelización diferenciados</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<div class="page-break"></div>

