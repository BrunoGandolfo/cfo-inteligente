{% extends 'base.html' %}

{% block content %}
<!-- PÁGINA 1: Resumen Ejecutivo -->
<div class="page">
    {% include 'components/_header.html' %}
    
    <div class="section-title">Resumen Ejecutivo</div>
    <div class="title-underline"></div>
    
    <!-- KPIs Principales -->
    <div class="kpi-grid">
        <div class="kpi-card">
            <div class="kpi-label">INGRESOS TOTALES</div>
            <div class="kpi-value">{{ total.actual.ingresos | format_currency_short }}</div>
            {% if total.variaciones.ingresos is defined %}
            <div class="kpi-change {% if total.variaciones.ingresos >= 0 %}positive{% else %}negative{% endif %}">
                {{ '↑' if total.variaciones.ingresos >= 0 else '↓' }} {{ total.variaciones.ingresos | abs }}% vs anterior
            </div>
            {% endif %}
        </div>
        <div class="kpi-card">
            <div class="kpi-label">RENTABILIDAD</div>
            <div class="kpi-value">{{ total.actual.rentabilidad | format_percent }}</div>
            {% if total.variaciones.rentabilidad_pp is defined %}
            <div class="kpi-change {% if total.variaciones.rentabilidad_pp >= 0 %}positive{% else %}negative{% endif %}">
                {{ '↑' if total.variaciones.rentabilidad_pp >= 0 else '↓' }} {{ total.variaciones.rentabilidad_pp | abs }} pp vs anterior
            </div>
            {% endif %}
        </div>
        <div class="kpi-card">
            <div class="kpi-label">RESULTADO NETO</div>
            <div class="kpi-value">{{ total.actual.resultado_neto | format_currency_short }}</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">% EXTRAÍDO</div>
            <div class="kpi-value {% if total.actual.ratio_extraccion > 70 %}negative{% endif %}">{{ total.actual.ratio_extraccion | format_percent }}</div>
        </div>
    </div>
    
    <!-- Narrativa generada por Claude -->
    <div class="narrative-box">
        <p class="narrative-text">
            {% if narrativas is defined and narrativas.resumen_ejecutivo is defined %}
            {{ narrativas.resumen_ejecutivo }}
            {% else %}
            Durante {{ metadata.periodo_label }}, Conexión Consultora registró ingresos totales de 
            <strong>{{ total.actual.ingresos | format_currency_short }}</strong> con una rentabilidad del 
            <strong>{{ total.actual.rentabilidad | format_percent }}</strong>. 
            {% if total.actual.ratio_extraccion > 70 %}
            <strong>Alerta:</strong> El ratio de extracción ({{ total.actual.ratio_extraccion | format_percent }}) supera el 70% recomendado.
            {% endif %}
            {% endif %}
        </p>
    </div>
    
    <!-- Gráfico Waterfall: Ingresos → Gastos → Resultado -->
    <div style="margin: 25px 0;">
        {% with ingresos=total.actual.ingresos, gastos=total.actual.gastos, resultado=total.actual.resultado_neto, rentabilidad=total.actual.rentabilidad %}
            {% include 'components/_waterfall_chart.html' %}
        {% endwith %}
    </div>
    
    <!-- Tabla Comparativa MVD vs Mercedes -->
    <div class="section-title" style="margin-top: 30px;">Comparativa por Localidad</div>
    <div style="page-break-inside: avoid;">
    <table class="table">
        <thead>
            <tr>
                <th class="table-header">MÉTRICA</th>
                <th class="table-header table-number">MONTEVIDEO</th>
                <th class="table-header table-number">%</th>
                <th class="table-header table-number">MERCEDES</th>
                <th class="table-header table-number">%</th>
                <th class="table-header table-number">TOTAL</th>
            </tr>
        </thead>
        <tbody>
            {% for row in comparativa %}
            <tr>
                <td>{{ row.metrica }}</td>
                <td class="table-number">{{ row.montevideo | format_currency_short }}</td>
                <td class="table-number">{{ row.montevideo_pct }}%</td>
                <td class="table-number">{{ row.mercedes | format_currency_short }}</td>
                <td class="table-number">{{ row.mercedes_pct }}%</td>
                <td class="table-number"><strong>{{ row.total | format_currency_short }}</strong></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    </div>
    
    <!-- Gráfico Distribución por Localidad -->
    <div style="margin: 20px 0 15px 0;">
        <div style="font-size: 11px; color: #4A5568; margin-bottom: 8px; font-weight: 500;">Distribución de Ingresos</div>
        {% set mvd_pct = (montevideo.actual.ingresos / total.actual.ingresos * 100) if total.actual.ingresos > 0 else 0 %}
        {% set mer_pct = (mercedes.actual.ingresos / total.actual.ingresos * 100) if total.actual.ingresos > 0 else 0 %}
        {% with montevideo_pct=mvd_pct, mercedes_pct=mer_pct %}
            {% include 'components/_bars_comparison.html' %}
        {% endwith %}
    </div>
    
    {% include 'components/_footer.html' %}
</div>

<!-- PÁGINA 2: Detalle Montevideo -->
<div class="page">
    {% include 'components/_header.html' %}
    
    <div class="section-title">Montevideo - Detalle</div>
    <div class="title-underline"></div>
    
    <div class="kpi-grid">
        <div class="kpi-card">
            <div class="kpi-label">INGRESOS</div>
            <div class="kpi-value">{{ montevideo.actual.ingresos | format_currency_short }}</div>
            {% if montevideo.variaciones.ingresos is defined %}
            <div class="kpi-change {% if montevideo.variaciones.ingresos >= 0 %}positive{% else %}negative{% endif %}">
                {{ montevideo.variaciones.ingresos | format_percent }} vs anterior
            </div>
            {% endif %}
        </div>
        <div class="kpi-card">
            <div class="kpi-label">GASTOS</div>
            <div class="kpi-value">{{ montevideo.actual.gastos | format_currency_short }}</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">RESULTADO</div>
            <div class="kpi-value">{{ montevideo.actual.resultado_neto | format_currency_short }}</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">RENTABILIDAD</div>
            <div class="kpi-value">{{ montevideo.actual.rentabilidad | format_percent }}</div>
        </div>
    </div>
    
    <div class="subsection-title" style="margin-top: 30px;">Extracciones Montevideo</div>
    <table class="table">
        <thead>
            <tr>
                <th class="table-header">CONCEPTO</th>
                <th class="table-header table-number">MONTO</th>
                <th class="table-header table-number">% DEL RESULTADO</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Retiros</td>
                <td class="table-number">{{ montevideo.actual.retiros | format_currency_short }}</td>
                <td class="table-number">{{ ((montevideo.actual.retiros / montevideo.actual.resultado_neto * 100) | round(1)) if montevideo.actual.resultado_neto > 0 else 0 }}%</td>
            </tr>
            <tr>
                <td>Distribuciones</td>
                <td class="table-number">{{ montevideo.actual.distribuciones | format_currency_short }}</td>
                <td class="table-number">{{ ((montevideo.actual.distribuciones / montevideo.actual.resultado_neto * 100) | round(1)) if montevideo.actual.resultado_neto > 0 else 0 }}%</td>
            </tr>
            <tr style="font-weight: 600; border-top: 2px solid #1a2b4a;">
                <td>Total Extraído</td>
                <td class="table-number">{{ montevideo.actual.total_extraido | format_currency_short }}</td>
                <td class="table-number {% if montevideo.actual.ratio_extraccion > 70 %}negative{% endif %}">{{ montevideo.actual.ratio_extraccion | format_percent }}</td>
            </tr>
            <tr style="font-weight: 600;">
                <td>Retenido en Empresa</td>
                <td class="table-number">{{ montevideo.actual.retenido | format_currency_short }}</td>
                <td class="table-number">{{ (100 - montevideo.actual.ratio_extraccion) | round(1) }}%</td>
            </tr>
        </tbody>
    </table>
    
    <!-- Análisis IA Montevideo -->
    {% if narrativas is defined and narrativas.analisis_montevideo is defined %}
    <div class="subsection-title" style="margin-top: 25px;">Análisis</div>
    <div class="narrative-box">
        <p class="narrative-text">{{ narrativas.analisis_montevideo }}</p>
    </div>
    {% endif %}
    
    {% include 'components/_footer.html' %}
</div>

<!-- PÁGINA 3: Detalle Mercedes -->
<div class="page">
    {% include 'components/_header.html' %}
    
    <div class="section-title">Mercedes - Detalle</div>
    <div class="title-underline"></div>
    
    <div class="kpi-grid">
        <div class="kpi-card">
            <div class="kpi-label">INGRESOS</div>
            <div class="kpi-value">{{ mercedes.actual.ingresos | format_currency_short }}</div>
            {% if mercedes.variaciones.ingresos is defined %}
            <div class="kpi-change {% if mercedes.variaciones.ingresos >= 0 %}positive{% else %}negative{% endif %}">
                {{ mercedes.variaciones.ingresos | format_percent }} vs anterior
            </div>
            {% endif %}
        </div>
        <div class="kpi-card">
            <div class="kpi-label">GASTOS</div>
            <div class="kpi-value">{{ mercedes.actual.gastos | format_currency_short }}</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">RESULTADO</div>
            <div class="kpi-value">{{ mercedes.actual.resultado_neto | format_currency_short }}</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">RENTABILIDAD</div>
            <div class="kpi-value">{{ mercedes.actual.rentabilidad | format_percent }}</div>
        </div>
    </div>
    
    <div class="subsection-title" style="margin-top: 30px;">Extracciones Mercedes</div>
    <table class="table">
        <thead>
            <tr>
                <th class="table-header">CONCEPTO</th>
                <th class="table-header table-number">MONTO</th>
                <th class="table-header table-number">% DEL RESULTADO</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Retiros</td>
                <td class="table-number">{{ mercedes.actual.retiros | format_currency_short }}</td>
                <td class="table-number">{{ ((mercedes.actual.retiros / mercedes.actual.resultado_neto * 100) | round(1)) if mercedes.actual.resultado_neto > 0 else 0 }}%</td>
            </tr>
            <tr>
                <td>Distribuciones</td>
                <td class="table-number">{{ mercedes.actual.distribuciones | format_currency_short }}</td>
                <td class="table-number">{{ ((mercedes.actual.distribuciones / mercedes.actual.resultado_neto * 100) | round(1)) if mercedes.actual.resultado_neto > 0 else 0 }}%</td>
            </tr>
            <tr style="font-weight: 600; border-top: 2px solid #1a2b4a;">
                <td>Total Extraído</td>
                <td class="table-number">{{ mercedes.actual.total_extraido | format_currency_short }}</td>
                <td class="table-number {% if mercedes.actual.ratio_extraccion > 70 %}negative{% endif %}">{{ mercedes.actual.ratio_extraccion | format_percent }}</td>
            </tr>
            <tr style="font-weight: 600;">
                <td>Retenido en Empresa</td>
                <td class="table-number">{{ mercedes.actual.retenido | format_currency_short }}</td>
                <td class="table-number">{{ (100 - mercedes.actual.ratio_extraccion) | round(1) }}%</td>
            </tr>
        </tbody>
    </table>
    
    <!-- Análisis IA Mercedes -->
    {% if narrativas is defined and narrativas.analisis_mercedes is defined %}
    <div class="subsection-title" style="margin-top: 25px;">Análisis</div>
    <div class="narrative-box">
        <p class="narrative-text">{{ narrativas.analisis_mercedes }}</p>
    </div>
    {% endif %}
    
    <!-- Alerta si Mercedes extrae más de lo que genera proporcionalmente -->
    {% set mvd_ratio_gen = (montevideo.actual.ingresos / total.actual.ingresos * 100) if total.actual.ingresos > 0 else 0 %}
    {% set mer_ratio_gen = (mercedes.actual.ingresos / total.actual.ingresos * 100) if total.actual.ingresos > 0 else 0 %}
    {% set mer_ratio_ext = (mercedes.actual.total_extraido / total.actual.total_extraido * 100) if total.actual.total_extraido > 0 else 0 %}
    
    {% if mer_ratio_ext > mer_ratio_gen + 5 %}
    <div class="alert-box" style="margin-top: 20px;">
        <strong>Alerta:</strong> Mercedes genera el {{ mer_ratio_gen | round(1) }}% de los ingresos pero extrae el {{ mer_ratio_ext | round(1) }}% del total.
    </div>
    {% endif %}
    
    {% include 'components/_footer.html' %}
</div>

<!-- PÁGINA 4: Conclusiones y Recomendaciones -->
<div class="page">
    {% include 'components/_header.html' %}
    
    <div class="section-title">Conclusiones y Recomendaciones</div>
    <div class="title-underline"></div>
    
    <!-- Fortalezas -->
    <div class="subsection-title">FORTALEZAS DEL PERÍODO</div>
    <div class="narrative-box">
        <ul style="margin: 0; padding-left: 20px; list-style-type: disc;">
            {% if narrativas is defined and narrativas.fortaleza_1 is defined %}
            <li style="margin-bottom: 8px;">{{ narrativas.fortaleza_1 }}</li>
            <li>{{ narrativas.fortaleza_2 }}</li>
            {% else %}
            <li style="margin-bottom: 8px;">Rentabilidad consolidada del {{ total.actual.rentabilidad | format_percent }}.</li>
            <li>Resultado neto positivo de {{ total.actual.resultado_neto | format_currency_short }}.</li>
            {% endif %}
        </ul>
    </div>
    
    <!-- Áreas de Atención -->
    <div class="subsection-title" style="margin-top: 25px;">ÁREAS DE ATENCIÓN</div>
    <div class="alert-box" style="padding: 15px; background: #fef9e7; border-left: 4px solid #d97706;">
        <div style="font-weight: 600; margin-bottom: 8px;">
            {% if narrativas is defined and narrativas.alerta_extracciones is defined %}
            {{ narrativas.alerta_extracciones }}
            {% else %}
            {% if total.actual.ratio_extraccion > 70 %}
            Ratio de extracción elevado ({{ total.actual.ratio_extraccion | format_percent }}). Revisar política de extracciones.
            {% else %}
            Sin alertas de extracción. Los niveles de retención son adecuados.
            {% endif %}
            {% endif %}
        </div>
        <ul style="margin: 10px 0 0 0; padding-left: 20px; list-style-type: disc;">
            {% if narrativas is defined and narrativas.atencion_1 is defined %}
            <li style="margin-bottom: 8px;">{{ narrativas.atencion_1 }}</li>
            <li>{{ narrativas.atencion_2 }}</li>
            {% else %}
            <li style="margin-bottom: 8px;">Monitorear equilibrio entre localidades.</li>
            <li>Revisar sostenibilidad de extracciones.</li>
            {% endif %}
        </ul>
    </div>
    
    <!-- Recomendaciones Estratégicas -->
    <div class="subsection-title" style="margin-top: 25px;">RECOMENDACIONES ESTRATÉGICAS</div>
    <table class="table">
        <thead>
            <tr>
                <th class="table-header" style="width: 80px;">PRIORIDAD</th>
                <th class="table-header">ACCIÓN</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><span style="color: #b91c1c; font-weight: 600;">Alta</span></td>
                <td>
                    {% if narrativas is defined and narrativas.recomendacion_1 is defined %}
                    {{ narrativas.recomendacion_1 }}
                    {% else %}
                    Analizar mix de servicios por localidad para identificar oportunidades.
                    {% endif %}
                </td>
            </tr>
            <tr>
                <td><span style="color: #d97706; font-weight: 600;">Media</span></td>
                <td>
                    {% if narrativas is defined and narrativas.recomendacion_2 is defined %}
                    {{ narrativas.recomendacion_2 }}
                    {% else %}
                    Establecer política de retención mínima del 30%.
                    {% endif %}
                </td>
            </tr>
            <tr>
                <td><span style="color: #1e6b4a; font-weight: 600;">Normal</span></td>
                <td>
                    {% if narrativas is defined and narrativas.recomendacion_3 is defined %}
                    {{ narrativas.recomendacion_3 }}
                    {% else %}
                    Revisar asignación de gastos entre oficinas.
                    {% endif %}
                </td>
            </tr>
        </tbody>
    </table>
    
    <!-- Análisis Comparativo IA -->
    <div class="subsection-title" style="margin-top: 25px;">ANÁLISIS COMPARATIVO</div>
    <div class="narrative-box">
        <p class="narrative-text">
            {% if narrativas is defined and narrativas.comparativa is defined %}
            {{ narrativas.comparativa }}
            {% else %}
            {% if montevideo.actual.ingresos > mercedes.actual.ingresos %}
            Montevideo lidera la facturación con el {{ (montevideo.actual.ingresos / total.actual.ingresos * 100) | round(1) }}% del total.
            {% else %}
            Mercedes lidera la facturación con el {{ (mercedes.actual.ingresos / total.actual.ingresos * 100) | round(1) }}% del total.
            {% endif %}
            La rentabilidad consolidada de {{ total.actual.rentabilidad | format_percent }} refleja la operación combinada de ambas oficinas.
            {% endif %}
        </p>
    </div>
    
    <!-- Nota de generación -->
    <div style="margin-top: 40px; padding: 15px; background: var(--gray-50); border-radius: 4px; font-size: 9px; color: var(--gray-500);">
        <strong>Nota:</strong> Este reporte fue generado automáticamente por el Sistema CFO Inteligente de Conexión Consultora. 
        {% if narrativas is defined %}
        Las narrativas y recomendaciones fueron elaboradas con asistencia de Claude Sonnet 4.5.
        {% endif %}
        Los datos provienen de los registros contables oficiales. Para consultas sobre metodología o datos específicos, 
        contactar al equipo de Administración y Finanzas.
    </div>
    
    {% include 'components/_footer.html' %}
</div>
{% endblock %}
